/**
 * Esc√°ner de c√≥digos de barras para la aplicaci√≥n m√≥vil
 * Utiliza la API de getUserMedia y ZXing para detectar c√≥digos
 */

class BarcodeScanner {
    constructor() {
        this.isScanning = false;
        this.stream = null;
        this.video = null;
        this.codeReader = null;
        this.currentCamera = 'environment'; // 'user' o 'environment'
        this.hasFlash = false;
        this.flashEnabled = false;
        
        // Elementos DOM
        this.elements = {};
        
        // Inicializar ZXing
        this.initializeZXing();
    }

    /**
     * Inicializa la librer√≠a ZXing
     */
    async initializeZXing() {
        try {
            // Cargar ZXing din√°micamente
            if (!window.ZXing) {
                await this.loadZXingLibrary();
            }
            
            this.codeReader = new ZXing.BrowserMultiFormatReader();
            console.log('‚úÖ ZXing inicializado correctamente');
        } catch (error) {
            console.error('‚ùå Error al inicializar ZXing:', error);
        }
    }

    /**
     * Carga la librer√≠a ZXing din√°micamente
     */
    loadZXingLibrary() {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@zxing/library@latest/umd/index.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    /**
     * Inicializa los elementos DOM
     */
    initializeElements() {
        this.elements = {
            scannerModal: document.getElementById('scannerModal'),
            closeScannerBtn: document.getElementById('closeScannerBtn'),
            scannerVideo: document.getElementById('scannerVideo'),
            scannerResult: document.getElementById('scannerResult'),
            detectedCode: document.getElementById('detectedCode'),
            searchDetectedBtn: document.getElementById('searchDetectedBtn')
        };
    }

    /**
     * Vincula los eventos
     */
    bindEvents() {
        // Cerrar modal
        this.elements.closeScannerBtn.addEventListener('click', () => this.closeScanner());
        
        // Buscar c√≥digo detectado
        this.elements.searchDetectedBtn.addEventListener('click', () => this.searchDetectedCode());
        
        // Cerrar modal al hacer clic fuera
        this.elements.scannerModal.addEventListener('click', (e) => {
            if (e.target === this.elements.scannerModal) {
                this.closeScanner();
            }
        });
    }

    /**
     * Abre el esc√°ner
     */
    async openScanner() {
        try {
            // Inicializar elementos si no est√°n inicializados
            if (!this.elements.scannerModal) {
                this.initializeElements();
                this.bindEvents();
            }

            // Verificar soporte de c√°mara
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Tu navegador no soporta acceso a la c√°mara');
            }

            // Mostrar modal
            this.elements.scannerModal.style.display = 'flex';
            
            // Ocultar resultado anterior
            this.elements.scannerResult.style.display = 'none';
            
            // Iniciar c√°mara
            await this.startCamera();
            
            // Iniciar escaneo
            this.startScanning();
            
            window.ui.showToast('Esc√°ner iniciado', 'success');

        } catch (error) {
            console.error('Error al abrir esc√°ner:', error);
            window.ui.showToast('Error: ' + error.message, 'error');
            this.closeScanner();
        }
    }

    /**
     * Inicia la c√°mara
     */
    async startCamera() {
        try {
            // Detener stream anterior si existe
            if (this.stream) {
                this.stopCamera();
            }

            // Configurar constraints
            const constraints = {
                video: {
                    facingMode: this.currentCamera,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            // Obtener stream de la c√°mara
            this.stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            // Asignar stream al video
            this.elements.scannerVideo.srcObject = this.stream;
            
            console.log('‚úÖ C√°mara iniciada');

        } catch (error) {
            console.error('Error al iniciar c√°mara:', error);
            
            if (error.name === 'NotAllowedError') {
                throw new Error('Permiso de c√°mara denegado. Permite el acceso a la c√°mara.');
            } else if (error.name === 'NotFoundError') {
                throw new Error('No se encontr√≥ ninguna c√°mara en el dispositivo.');
            } else {
                throw new Error('Error al acceder a la c√°mara: ' + error.message);
            }
        }
    }

    /**
     * Detiene la c√°mara
     */
    stopCamera() {
        if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
            this.stream = null;
        }
        
        if (this.elements.scannerVideo) {
            this.elements.scannerVideo.srcObject = null;
        }
    }

    /**
     * Inicia el escaneo de c√≥digos
     */
    startScanning() {
        if (!this.codeReader || this.isScanning) return;

        this.isScanning = true;
        
        // Usar ZXing para detectar c√≥digos
        this.codeReader.decodeFromVideoDevice(
            undefined, // deviceId (undefined = usar el stream actual)
            this.elements.scannerVideo,
            (result, error) => {
                if (result) {
                    // C√≥digo detectado
                    this.onCodeDetected(result.text);
                }
                
                if (error && error.name !== 'NotFoundException') {
                    console.warn('Error de escaneo:', error);
                }
            }
        );
    }

    /**
     * Detiene el escaneo
     */
    stopScanning() {
        if (this.codeReader && this.isScanning) {
            this.codeReader.reset();
            this.isScanning = false;
        }
    }

    /**
     * Maneja la detecci√≥n de un c√≥digo
     */
    onCodeDetected(code) {
        console.log('üéØ C√≥digo detectado:', code);
        
        // Detener escaneo
        this.stopScanning();
        
        // Mostrar resultado
        this.elements.detectedCode.textContent = code;
        this.elements.scannerResult.style.display = 'block';
        
        // Vibraci√≥n si est√° disponible
        if (navigator.vibrate) {
            navigator.vibrate(200);
        }
        
        // Sonido de √©xito (opcional)
        this.playSuccessSound();
        
        window.ui.showToast('¬°C√≥digo detectado!', 'success');
        
        // B√∫squeda autom√°tica del c√≥digo detectado
        setTimeout(() => {
            this.searchDetectedCode();
        }, 1000); // Esperar 1 segundo para que el usuario vea el c√≥digo detectado
    }

    /**
     * Reproduce sonido de √©xito
     */
    playSuccessSound() {
        try {
            // Crear un sonido simple usando Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        } catch (error) {
            // Silenciar errores de audio
        }
    }

    /**
     * Busca el c√≥digo detectado y a√±ade autom√°ticamente si es √∫nico
     */
    async searchDetectedCode() {
        const code = this.elements.detectedCode.textContent;
        if (code) {
            // Cerrar esc√°ner
            this.closeScanner();
            
            // Buscar productos con este c√≥digo espec√≠fico
            try {
                const results = await window.storageManager.searchProducts(code, '', 10);
                
                if (results.length === 1) {
                    // Si hay exactamente un producto, a√±adirlo autom√°ticamente
                    const product = results[0];
                    await window.ui.addProductToList(product.codigo);
                    window.ui.showToast(`‚úÖ ${product.descripcion} a√±adido autom√°ticamente`, 'success');
                } else if (results.length > 1) {
                    // Si hay m√∫ltiples productos, mostrar resultados para que el usuario elija
                    window.ui.elements.codeInput.value = code;
                    window.ui.performSmartSearch();
                    window.ui.showToast(`üîç ${results.length} productos encontrados. Selecciona el correcto.`, 'info');
                } else {
                    // Si no se encuentra el producto
                    window.ui.elements.codeInput.value = code;
                    window.ui.showToast(`‚ùå No se encontr√≥ producto con c√≥digo ${code}`, 'warning');
                }
            } catch (error) {
                console.error('Error al buscar c√≥digo detectado:', error);
                // Fallback: usar b√∫squeda normal
                if (window.ui) {
                    window.ui.elements.codeInput.value = code;
                    window.ui.performSmartSearch();
                }
            }
        }
    }

    /**
     * Cierra el esc√°ner
     */
    closeScanner() {
        // Detener escaneo y c√°mara
        this.stopScanning();
        this.stopCamera();
        
        // Ocultar modal
        if (this.elements.scannerModal) {
            this.elements.scannerModal.style.display = 'none';
        }
        
        // Reset flash
        this.flashEnabled = false;
        
        console.log('üì∑ Esc√°ner cerrado');
    }
}

// Instancia global del esc√°ner
window.scanner = new BarcodeScanner();
